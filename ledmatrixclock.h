#include <WiFiUdp.h>
#include <ESP8266WiFi.h>
#include "LedControl.h"
// #include <ESPAsyncTCP.h>
// #include <ESPAsyncWebServer.h>
#include <ESP8266WebServer.h>
#include <simpleDSTadjust.h>

const char* ota_hostname = "matrixclock";
unsigned long timeout = 0;
char brightness = 0x00;
const unsigned long REFRESH_RATE = 10*60*1000;
long lastDownloadUpdate = millis();

#define UTC_OFFSET -8
struct dstRule StartRule = {"PDT", Second, Sun, Mar, 2, 3600}; // Pacific Daylight time = UTC/GMT -7 hours
struct dstRule EndRule = {"PST", First, Sun, Nov, 1, 0};       // Pacific Standard time = UTC/GMT -8 hour
// change for different NTP (time servers)
#define NTP_SERVERS "us.pool.ntp.org", "time.nist.gov", "pool.ntp.org"

// August 1st, 2018
#define NTP_MIN_VALID_EPOCH 1533081600

simpleDSTadjust dstAdjusted(StartRule, EndRule);

// AsyncWebServer    server1 ( 80 );
 ESP8266WebServer server(80); 
// WiFiServer TelnetServer(APORT);
// WiFiClient Telnet;

WiFiUDP udp;

/*
 Now we need a LedControl to work with.
 ***** These pin numbers will probably not work with your hardware *****
 pin 12 is connected to the DataIn 
 pin 11 is connected to the CLK 
 pin 10 is connected to LOAD 
 We have only a single MAX72XX.
 */
LedControl lc=LedControl(D4,D2,D3,1);
boolean display_words = true;

/*
 
 HATWENTY
 FIFVTEEN
 LF*PASTO
 NINEIGHT
 ONETHREE
 TWELEVEN
 FOURFIVE
 SIXSEVEN
 
 // */

const int MIN_OFFSET=7; // 12:00 + 5*7 min = twentyfive to ONE

const char MINUTES_WORDS[12][8] ={
  { // o'clock
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000
  }
  , { // five past
    0B00000000,
    0B11010100,
    0B00011110,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000
  }
  , { // ten past
    0B00000000,
    0B00001101,
    0B00011110,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000
  }
  ,{ // fifteen past
    0B00000000,
    0B11101111,
    0B00011110,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000
  }
  ,{ // twenty past
    0B00111111,
    0B00000000,
    0B00011110,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000
  }
  ,{ // twentyfive past
    0B00111111,
    0B11010100,
    0B00011110,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000
  }
  ,{ // half past
    0B11000000,
    0B00000000,
    0B11011110,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000
  }
  ,{ // twentyfive to
    0B00111111,
    0B11010100,
    0B00000011,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000
  }
  ,{ // twenty to
    0B00111111,
    0B00000000,
    0B00000011,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000
  }
  ,{ // fifteen to
    0B00000000,
    0B11101111,
    0B00000011,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000
  }
  ,{ // ten to
    0B00000000,
    0B00001101,
    0B00000011,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000
  }
  ,{ // five to
    0B00000000,
    0B11010100,
    0B00000011,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000
  }
};

const char HOURS_WORDS[12][8] ={
  { // twelve
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B11110110,
    0B00000000,
    0B00000000
  }
  ,{ // one
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B11100000,
    0B00000000,
    0B00000000,
    0B00000000
  }
  ,{ // two
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B11000000,
    0B01000000,
    0B00000000
  }
  ,{ // three
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00011111,
    0B00000000,
    0B00000000,
    0B00000000
  }
  ,{ // four
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B11110000,
    0B00000000
  }
  ,{ // five
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00001111,
    0B00000000
  }
  ,{ // six
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B11100000
  }
  ,{ // seven
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00011111
  }
  ,{ // eight
    0B00000000,
    0B00000000,
    0B00000000,
    0B00011111,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000
  }
  ,{ // nine
    0B00000000,
    0B00000000,
    0B00000000,
    0B11110000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000
  }
  ,{ // ten
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00000000,
    0B00000000
  }
  ,{ // eleven
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00111111,
    0B00000000,
    0B00000000
  }
};

const char BLINKY[2][8] ={
  { 
  0B00000000,
  0B00000000,
  0B00000000,
  0B00000000,
  0B00000000,
  0B00000000,
  0B00000000,
  0B00000000
  }
  ,{
  0B00000000,
  0B00000000,
  0B00100000,
  0B00000000,
  0B00000000,
  0B00000000,
  0B00000000,
  0B00000000
  }
};

const char HOURS[12][8] = {
  { // twelve
    0B00000000,
    0B00000000,
    0B00101100,
    0B00100100,
    0B00101000,
    0B00101100,
    0B00000000,
    0B00000000
  }
  ,{ // one
    0B00000000,
    0B00000000,
    0B00011000,
    0B00001000,
    0B00001000,
    0B00011100,
    0B00000000,
    0B00000000
  }
  ,{ // two
    0B00000000,
    0B00000000,
    0B00011000,
    0B00000100,
    0B00001000,
    0B00011100,
    0B00000000,
    0B00000000
  }
  ,{ // three
    0B00000000,
    0B00000000,
    0B00011100,
    0B00001100,
    0B00000100,
    0B00011100,
    0B00000000,
    0B00000000
  }
  ,{ // four
    0B00000000,
    0B00000000,
    0B00010000,
    0B00010100,
    0B00011100,
    0B00000100,
    0B00000000,
    0B00000000
  }
  ,{ // five
    0B00000000,
    0B00000000,
    0B00011100,
    0B00011000,
    0B00000100,
    0B00011000,
    0B00000000,
    0B00000000
  }
  ,{ // six
    0B00000000,
    0B00000000,
    0B00010000,
    0B00011100,
    0B00010100,
    0B00011100,
    0B00000000,
    0B00000000
  }
  ,{ // seven
    0B00000000,
    0B00000000,
    0B00011100,
    0B00000100,
    0B00000100,
    0B00000100,
    0B00000000,
    0B00000000
  }
  ,{ // eight
    0B00000000,
    0B00000000,
    0B00111000,
    0B00101000,
    0B00010100,
    0B00011100,
    0B00000000,
    0B00000000
  }
  ,{ // nine
    0B00000000,
    0B00000000,
    0B00011100,
    0B00010100,
    0B00011100,
    0B00000100,
    0B00000000,
    0B00000000
  }
  ,{ // ten
    0B00000000,
    0B00000000,
    0B00101000,
    0B00110100,
    0B00110100,
    0B00101000,
    0B00000000,
    0B00000000
  }
  ,{ // eleven
    0B00000000,
    0B00000000,
    0B00010100,
    0B00010100,
    0B00010100,
    0B00010100,
    0B00000000,
    0B00000000
  }
};

const char MINUTES[28][8] = {
  { // 
    0B00001000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000
  }
  ,{ // 
    0B00001100,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000
  }
  ,{ // 
    0B00001110,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000
  }
  ,{ // 
    0B00001111,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000
  }
  ,{ // 
    0B00001111,
    0B00000001,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000
  }
  ,{ // 
    0B00001111,
    0B00000001,
    0B00000001,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000
  }
  ,{ // 
    0B00001111,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000
  }
  ,{ // 
    0B00001111,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00000000,
    0B00000000,
    0B00000000
  }
  ,{ // 
    0B00001111,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00000000,
    0B00000000
  }
  ,{ // 
    0B00001111,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00000000
  }
  ,{ // 
    0B00001111,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00000001
  }
  ,{ // 
    0B00001111,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00000011
  }
  ,{ // 
    0B00001111,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00000111
  }
  ,{ // 
    0B00001111,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00001111
  }
  ,{ // 
    0B00001111,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00011111
  }
  ,{ // 
    0B00001111,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00111111
  }
  ,{ // 
    0B00001111,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00000001,
    0B01111111
  }
  ,{ // 
    0B00001111,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00000001,
    0B11111111
  }
  ,{ // 
    0B00001111,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00000001,
    0B10000001,
    0B11111111
  }
  ,{ // 
    0B00001111,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00000001,
    0B10000001,
    0B10000001,
    0B11111111
  },{ // 
    0B00001111,
    0B00000001,
    0B00000001,
    0B00000001,
    0B10000001,
    0B10000001,
    0B10000001,
    0B11111111
  }
  ,{ // 
    0B00001111,
    0B00000001,
    0B00000001,
    0B10000001,
    0B10000001,
    0B10000001,
    0B10000001,
    0B11111111
  }
  ,{ // 
    0B00001111,
    0B00000001,
    0B10000001,
    0B10000001,
    0B10000001,
    0B10000001,
    0B10000001,
    0B11111111
  }
  ,{ // 
    0B00001111,
    0B10000001,
    0B10000001,
    0B10000001,
    0B10000001,
    0B10000001,
    0B10000001,
    0B11111111
  }
  ,{ // 
    0B10001111,
    0B10000001,
    0B10000001,
    0B10000001,
    0B10000001,
    0B10000001,
    0B10000001,
    0B11111111
  }
  ,{ // 
    0B11001111,
    0B10000001,
    0B10000001,
    0B10000001,
    0B10000001,
    0B10000001,
    0B10000001,
    0B11111111
  }
  ,{ // 
    0B11101111,
    0B10000001,
    0B10000001,
    0B10000001,
    0B10000001,
    0B10000001,
    0B10000001,
    0B11111111
  }
  ,{ // 
    0B11111111,
    0B10000001,
    0B10000001,
    0B10000001,
    0B10000001,
    0B10000001,
    0B10000001,
    0B11111111
  }
};

const char ANIMATION[28][8] = {
  { // 
    0B00001000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000
  }
  ,{ // 
    0B00000100,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000
  }
  ,{ // 
    0B00000010,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000
  }
  ,{ // 
    0B00000001,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000
  }
  ,{ // 
    0B00000000,
    0B00000001,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000
  }
  ,{ // 
    0B00000000,
    0B00000000,
    0B00000001,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000
  }
  ,{ // 
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000001,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000
  }
  ,{ // 
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000001,
    0B00000000,
    0B00000000,
    0B00000000
  }
  ,{ // 
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000001,
    0B00000000,
    0B00000000
  }
  ,{ // 
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000001,
    0B00000000
  }
  ,{ // 
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000001
  }
  ,{ // 
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000010
  }
  ,{ // 
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000100
  }
  ,{ // 
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00001000
  }
  ,{ // 
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00010000
  }
  ,{ // 
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00100000
  }
  ,{ // 
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B01000000
  }
  ,{ // 
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B10000000
  }
  ,{ // 
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B10000000,
    0B00000000
  }
  ,{ // 
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B10000000,
    0B00000000,
    0B00000000
  },{ // 
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B10000000,
    0B00000000,
    0B00000000,
    0B00000000
  }
  ,{ // 
    0B00000000,
    0B00000000,
    0B00000000,
    0B10000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000
  }
  ,{ // 
    0B00000000,
    0B00000000,
    0B10000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000
  }
  ,{ // 
    0B00000000,
    0B10000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000
  }
  ,{ // 
    0B10000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000
  }
  ,{ // 
    0B01000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000
  }
  ,{ // 
    0B00100000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000
  }
  ,{ // 
    0B00010000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000
  }
};

const char RING[2][8] = {
    { 
  0B11111111,
  0B10000001,
  0B10000001,
  0B10000001,
  0B10000001,
  0B10000001,
  0B10000001,
  0B11111111
  }
  ,{
  0B00000000,
  0B00000000,
  0B00000000,
  0B00000000,
  0B00000000,
  0B00000000,
  0B00000000,
  0B00000000
  }
};


