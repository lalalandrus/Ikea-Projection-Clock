#include <WiFiUdp.h>
#include <ESP8266WiFi.h>
#include "LedControl.h"
#include <ESPAsyncTCP.h>
#include <ESPAsyncWebServer.h>

const char* SSID_SET = "****************";
const char* PASSWORD = "****************";
const char* ota_hostname = "matrixclock";
const uint16_t APORT = 8266;
const unsigned int LOCAL_PORT = 2390;      // local port to listen for UDP packets
const char* NTP_SERVER_NAME = "time.nist.gov";
const int NTP_PACKET_SIZE = 48; // NTP time stamp is in the first 48 bytes of the message
const byte SENDBUFFER[] = {
  0b11100011,          // LI, Version, Mode.
  0x0,                 // Stratum unspecified.
  0x6,                 // Polling interval
  0xEC,                // Clock precision.
  0x0, 0x0, 0x0, 0x0,
  0x0, 0x0, 0x0, 0x0,
  0x31, 0x4E, 0x31, 0x34,
  0x0, 0x0, 0x0, 0x0,
  0x0, 0x0, 0x0, 0x0,
  0x0, 0x0, 0x0, 0x0,
  0x0, 0x0, 0x0, 0x0,
  0x0, 0x0, 0x0, 0x0,
  0x0, 0x0, 0x0, 0x0,
  0x0, 0x0, 0x0, 0x0,
  0x0, 0x0, 0x0, 0x0}; // Reference ...
const unsigned long REFRESH_RATE = 2500000;
unsigned long timeout = 0;


AsyncWebServer    server1 ( 80 );
// ESP8266WebServer server(80); 
// WiFiServer TelnetServer(APORT);
// WiFiClient Telnet;

/* Don't hardwire the IP address or we won't get the benefits of the pool.
 *  Lookup the IP address for the host name instead */
//IPAddress timeServer(129, 6, 15, 28); // time.nist.gov NTP server
IPAddress timeServerIP; // time.nist.gov NTP server address
byte packetBuffer[ NTP_PACKET_SIZE]; //buffer to hold incoming and outgoing packets
const int BASE_TIMEZONE = -8;     // PST
// format is month, first/second/third/fouth/last, day of week (sunday = 1)
const int DST_START[]={4,1,1};
const int DST_END[]={10,5,1};
int timeZone = 0;
const int LEAP_ORDINAL[] = {0,31,60,91,121,152,182,213,244,274,305,335};
const int ORDINAL[] = {0,31,59,90,120,151,181,212,243,273,304,334};

const int LEAP_MONTH_DAYS[] = {0,31,28,31,30,31,30,31,31,30,31,30,31};
const int MONTH_DAYS[] = {0,31,29,31,30,31,30,31,31,30,31,30,31};

WiFiUDP udp;

/*
 Now we need a LedControl to work with.
 ***** These pin numbers will probably not work with your hardware *****
 pin 12 is connected to the DataIn 
 pin 11 is connected to the CLK 
 pin 10 is connected to LOAD 
 We have only a single MAX72XX.
 */
LedControl lc=LedControl(D4,D2,D3,1);
boolean display_words = true;

/*
 
 HATWENTY
 FIFVTEEN
 LF*PASTO
 NINEIGHT
 ONETHREE
 TWELEVEN
 FOURFIVE
 SIXSEVEN
 
 // */

const int MIN_OFFSET=7; // 12:00 + 5*7 min = twentyfive to ONE

const char MINUTES_WORDS[12][8] ={
  { // o'clock
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000
  }
  , { // five past
    0B00000000,
    0B11010100,
    0B00011110,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000
  }
  , { // ten past
    0B00000000,
    0B00001101,
    0B00011110,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000
  }
  ,{ // fifteen past
    0B00000000,
    0B11101111,
    0B00011110,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000
  }
  ,{ // twenty past
    0B00111111,
    0B00000000,
    0B00011110,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000
  }
  ,{ // twentyfive past
    0B00111111,
    0B11010100,
    0B00011110,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000
  }
  ,{ // half past
    0B11000000,
    0B00000000,
    0B11011110,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000
  }
  ,{ // twentyfive to
    0B00111111,
    0B11010100,
    0B00000011,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000
  }
  ,{ // twenty to
    0B00111111,
    0B00000000,
    0B00000011,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000
  }
  ,{ // fifteen to
    0B00000000,
    0B11101111,
    0B00000011,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000
  }
  ,{ // ten to
    0B00000000,
    0B00001101,
    0B00000011,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000
  }
  ,{ // five to
    0B00000000,
    0B11010100,
    0B00000011,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000
  }
};

const char HOURS_WORDS[12][8] ={
  { // twelve
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B11110110,
    0B00000000,
    0B00000000
  }
  ,{ // one
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B11100000,
    0B00000000,
    0B00000000,
    0B00000000
  }
  ,{ // two
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B11000000,
    0B01000000,
    0B00000000
  }
  ,{ // three
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00011111,
    0B00000000,
    0B00000000,
    0B00000000
  }
  ,{ // four
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B11110000,
    0B00000000
  }
  ,{ // five
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00001111,
    0B00000000
  }
  ,{ // six
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B11100000
  }
  ,{ // seven
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00011111
  }
  ,{ // eight
    0B00000000,
    0B00000000,
    0B00000000,
    0B00011111,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000
  }
  ,{ // nine
    0B00000000,
    0B00000000,
    0B00000000,
    0B11110000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000
  }
  ,{ // ten
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00000000,
    0B00000000
  }
  ,{ // eleven
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00111111,
    0B00000000,
    0B00000000
  }
};

const char BLINKY[2][8] ={
  { 
  0B00000000,
  0B00000000,
  0B00000000,
  0B00000000,
  0B00000000,
  0B00000000,
  0B00000000,
  0B00000000
  }
  ,{
  0B00000000,
  0B00000000,
  0B00100000,
  0B00000000,
  0B00000000,
  0B00000000,
  0B00000000,
  0B00000000
  }
};

const char HOURS[12][8] = {
  { // twelve
    0B00000000,
    0B00000000,
    0B00101100,
    0B00100100,
    0B00101000,
    0B00101100,
    0B00000000,
    0B00000000
  }
  ,{ // one
    0B00000000,
    0B00000000,
    0B00011000,
    0B00001000,
    0B00001000,
    0B00011100,
    0B00000000,
    0B00000000
  }
  ,{ // two
    0B00000000,
    0B00000000,
    0B00011000,
    0B00000100,
    0B00001000,
    0B00011100,
    0B00000000,
    0B00000000
  }
  ,{ // three
    0B00000000,
    0B00000000,
    0B00011100,
    0B00001100,
    0B00000100,
    0B00011100,
    0B00000000,
    0B00000000
  }
  ,{ // four
    0B00000000,
    0B00000000,
    0B00010000,
    0B00010100,
    0B00011100,
    0B00000100,
    0B00000000,
    0B00000000
  }
  ,{ // five
    0B00000000,
    0B00000000,
    0B00011100,
    0B00011000,
    0B00000100,
    0B00011000,
    0B00000000,
    0B00000000
  }
  ,{ // six
    0B00000000,
    0B00000000,
    0B00010000,
    0B00011100,
    0B00010100,
    0B00011100,
    0B00000000,
    0B00000000
  }
  ,{ // seven
    0B00000000,
    0B00000000,
    0B00011100,
    0B00000100,
    0B00000100,
    0B00000100,
    0B00000000,
    0B00000000
  }
  ,{ // eight
    0B00000000,
    0B00000000,
    0B00111000,
    0B00101000,
    0B00010100,
    0B00011100,
    0B00000000,
    0B00000000
  }
  ,{ // nine
    0B00000000,
    0B00000000,
    0B00011100,
    0B00010100,
    0B00011100,
    0B00000100,
    0B00000000,
    0B00000000
  }
  ,{ // ten
    0B00000000,
    0B00000000,
    0B00101000,
    0B00110100,
    0B00110100,
    0B00101000,
    0B00000000,
    0B00000000
  }
  ,{ // eleven
    0B00000000,
    0B00000000,
    0B00010100,
    0B00010100,
    0B00010100,
    0B00010100,
    0B00000000,
    0B00000000
  }
};

const char MINUTES[28][8] = {
  { // 
    0B00001000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000
  }
  ,{ // 
    0B00001100,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000
  }
  ,{ // 
    0B00001110,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000
  }
  ,{ // 
    0B00001111,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000
  }
  ,{ // 
    0B00001111,
    0B00000001,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000
  }
  ,{ // 
    0B00001111,
    0B00000001,
    0B00000001,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000
  }
  ,{ // 
    0B00001111,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000
  }
  ,{ // 
    0B00001111,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00000000,
    0B00000000,
    0B00000000
  }
  ,{ // 
    0B00001111,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00000000,
    0B00000000
  }
  ,{ // 
    0B00001111,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00000000
  }
  ,{ // 
    0B00001111,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00000001
  }
  ,{ // 
    0B00001111,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00000011
  }
  ,{ // 
    0B00001111,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00000111
  }
  ,{ // 
    0B00001111,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00001111
  }
  ,{ // 
    0B00001111,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00011111
  }
  ,{ // 
    0B00001111,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00111111
  }
  ,{ // 
    0B00001111,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00000001,
    0B01111111
  }
  ,{ // 
    0B00001111,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00000001,
    0B11111111
  }
  ,{ // 
    0B00001111,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00000001,
    0B10000001,
    0B11111111
  }
  ,{ // 
    0B00001111,
    0B00000001,
    0B00000001,
    0B00000001,
    0B00000001,
    0B10000001,
    0B10000001,
    0B11111111
  },{ // 
    0B00001111,
    0B00000001,
    0B00000001,
    0B00000001,
    0B10000001,
    0B10000001,
    0B10000001,
    0B11111111
  }
  ,{ // 
    0B00001111,
    0B00000001,
    0B00000001,
    0B10000001,
    0B10000001,
    0B10000001,
    0B10000001,
    0B11111111
  }
  ,{ // 
    0B00001111,
    0B00000001,
    0B10000001,
    0B10000001,
    0B10000001,
    0B10000001,
    0B10000001,
    0B11111111
  }
  ,{ // 
    0B00001111,
    0B10000001,
    0B10000001,
    0B10000001,
    0B10000001,
    0B10000001,
    0B10000001,
    0B11111111
  }
  ,{ // 
    0B10001111,
    0B10000001,
    0B10000001,
    0B10000001,
    0B10000001,
    0B10000001,
    0B10000001,
    0B11111111
  }
  ,{ // 
    0B11001111,
    0B10000001,
    0B10000001,
    0B10000001,
    0B10000001,
    0B10000001,
    0B10000001,
    0B11111111
  }
  ,{ // 
    0B11101111,
    0B10000001,
    0B10000001,
    0B10000001,
    0B10000001,
    0B10000001,
    0B10000001,
    0B11111111
  }
  ,{ // 
    0B11111111,
    0B10000001,
    0B10000001,
    0B10000001,
    0B10000001,
    0B10000001,
    0B10000001,
    0B11111111
  }
};

/*
 * const char MINUTES[28][8] = {
  { // 
    0B00001000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000
  }
  ,{ // 
    0B00000100,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000
  }
  ,{ // 
    0B00000010,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000
  }
  ,{ // 
    0B00000001,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000
  }
  ,{ // 
    0B00000000,
    0B00000001,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000
  }
  ,{ // 
    0B00000000,
    0B00000000,
    0B00000001,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000
  }
  ,{ // 
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000001,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000
  }
  ,{ // 
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000001,
    0B00000000,
    0B00000000,
    0B00000000
  }
  ,{ // 
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000001,
    0B00000000,
    0B00000000
  }
  ,{ // 
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000001,
    0B00000000
  }
  ,{ // 
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000001
  }
  ,{ // 
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000010
  }
  ,{ // 
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000100
  }
  ,{ // 
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00001000
  }
  ,{ // 
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00010000
  }
  ,{ // 
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00100000
  }
  ,{ // 
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B01000000
  }
  ,{ // 
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B10000000
  }
  ,{ // 
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B10000000,
    0B00000000
  }
  ,{ // 
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B10000000,
    0B00000000,
    0B00000000
  },{ // 
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B10000000,
    0B00000000,
    0B00000000,
    0B00000000
  }
  ,{ // 
    0B00000000,
    0B00000000,
    0B00000000,
    0B10000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000
  }
  ,{ // 
    0B00000000,
    0B00000000,
    0B10000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000
  }
  ,{ // 
    0B00000000,
    0B10000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000
  }
  ,{ // 
    0B10000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000
  }
  ,{ // 
    0B01000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000
  }
  ,{ // 
    0B00100000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000
  }
  ,{ // 
    0B00010000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000,
    0B00000000
  }
};
 */
const char RING[2][8] = {
    { 
  0B11111111,
  0B10000001,
  0B10000001,
  0B10000001,
  0B10000001,
  0B10000001,
  0B10000001,
  0B11111111
  }
  ,{
  0B00000000,
  0B00000000,
  0B00000000,
  0B00000000,
  0B00000000,
  0B00000000,
  0B00000000,
  0B00000000
  }
};


